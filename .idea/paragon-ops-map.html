<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paragon Operations Map</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8f 100%);
      color: white;
      padding: 30px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 32px; font-weight: 700; }
    .header-meta { text-align: right; }
    .header-meta p { margin: 5px 0; opacity: 0.9; }

    .controls {
      padding: 20px 40px;
      background: #f8f9fa;
      border-bottom: 2px solid #dee2e6;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary { background: #667eea; color: white; }
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary { background: #6c757d; color: white; }
    .btn-secondary:hover { background: #5a6268; }

    .btn-success { background: #28a745; color: white; }
    .btn-success:hover { background: #218838; }

    .view-toggle {
      display: flex;
      gap: 5px;
      background: #dee2e6;
      padding: 5px;
      border-radius: 8px;
    }

    .view-toggle-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: transparent;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .view-toggle-btn.active {
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .legend { display: flex; gap: 20px; margin-left: auto; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 2px solid rgba(0,0,0,0.1);
    }

    .content { padding: 40px; overflow-x: auto; }

    /* ========== CARD/TRACKING VIEW ========== */
    .org-chart { display: flex; flex-direction: column; gap: 40px; min-width: 1200px; }

    .company {
      background: linear-gradient(135deg, #1e3a5f 0%, #2d5a8f 100%);
      color: white;
      padding: 30px 40px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(30, 58, 95, 0.3);
    }

    .company h2 { font-size: 28px; font-weight: 700; }

    .departments {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 30px;
    }

    .department {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .department:hover {
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      transform: translateY(-5px);
    }

    .department-header {
      padding: 20px 25px;
      color: white;
      font-weight: 700;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
    }

    .department-header:hover { filter: brightness(1.1); }
    .expand-icon { transition: transform 0.3s ease; font-size: 20px; }
    .expanded .expand-icon { transform: rotate(180deg); }

    /* Department colors */
    .dept-accounting { background: linear-gradient(135deg, #06A77D 0%, #05c896 100%); }
    .dept-client { background: linear-gradient(135deg, #00A6A6 0%, #00c4c4 100%); }
    .dept-compliance { background: linear-gradient(135deg, #7A4988 0%, #9357a8 100%); }
    .dept-leasing { background: linear-gradient(135deg, #4A90E2 0%, #5ba3f5 100%); }
    .dept-maintenance { background: linear-gradient(135deg, #FF6B35 0%, #ff8555 100%); }
    .dept-tenant { background: linear-gradient(135deg, #F39C12 0%, #f5b042 100%); }

    .department-body { padding: 25px; display: none; }
    .department.expanded .department-body { display: block; }

    .task-list { display: flex; flex-direction: column; gap: 15px; }

    .task-item {
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 8px;
      border-left: 4px solid;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.2s ease;
    }

    .task-item:hover {
      background: #e9ecef;
      transform: translateX(5px);
    }

    .task-name { font-weight: 600; color: #2c3e50; }

    .task-owner {
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 700;
      color: white;
      white-space: nowrap;
    }

    /* Team member colors */
    .owner-nathan { background: #FF6B35; }
    .owner-patrick { background: #4A90E2; }
    .owner-austin { background: #00A6A6; }
    .owner-cathryn { background: #7A4988; }
    .owner-linda { background: #06A77D; }
    .owner-jason { background: #1e3a5f; }
    .owner-carlos { background: #E74C3C; }
    .owner-unowned {
      background: #dc3545;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .task-item.unowned {
      border-left-color: #dc3545;
      background: #fff5f5;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.3;
    }

    /* ========== MAP/FLOW VIEW ========== */
    .flow-map-container {
      display: none;
      min-height: 800px;
      padding: 20px;
      position: relative;
    }

    .flow-map-container.active {
      display: block;
    }

    #flowMap {
      width: 100%;
      height: 100%;
      min-height: 800px;
    }

    .map-node {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .map-node:hover {
      filter: brightness(1.1);
    }

    .map-node-text {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: 600;
      pointer-events: none;
    }

    .map-connection {
      stroke: #cbd5e0;
      stroke-width: 2;
      fill: none;
    }

    .map-connection.unowned {
      stroke: #dc3545;
      stroke-width: 3;
      stroke-dasharray: 5,5;
      animation: dash 1s linear infinite;
    }

    @keyframes dash {
      to { stroke-dashoffset: -10; }
    }

    /* Stats */
    .stats {
      padding: 20px 40px;
      background: #f8f9fa;
      border-top: 2px solid #dee2e6;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .stat-label {
      font-size: 13px;
      color: #6c757d;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #2c3e50;
      margin-top: 8px;
    }

    .stat-card.danger .stat-value {
      color: #dc3545;
    }

    .hidden { display: none; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div>
      <h1>üè¢ Paragon Operations Map</h1>
      <p>Knowledge Transfer Project</p>
    </div>
    <div class="header-meta">
      <p><strong>Created:</strong> February 16, 2026</p>
      <p><strong>Manager:</strong> Carlos Sanchez</p>
      <p><strong>Target Date:</strong> March 31, 2026</p>
    </div>
  </div>

  <div class="controls">
    <div class="view-toggle">
      <button class="view-toggle-btn active" onclick="switchView('tracking')" id="trackingViewBtn">
        üìä Tracking View
      </button>
      <button class="view-toggle-btn" onclick="switchView('map')" id="mapViewBtn">
        üó∫Ô∏è Map View
      </button>
    </div>

    <button class="btn btn-primary" onclick="expandAll()" id="expandBtn">üìÇ Expand All</button>
    <button class="btn btn-secondary" onclick="collapseAll()" id="collapseBtn">üìÅ Collapse All</button>
    <button class="btn btn-primary" onclick="exportToPNG()">üì∏ Export to Image</button>
    <button class="btn btn-secondary" onclick="printMap()">üñ®Ô∏è Print</button>

    <div class="legend">
      <div class="legend-item">
        <div class="legend-color" style="background: #FF6B35;"></div>
        <span>Nathan S.</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #4A90E2;"></div>
        <span>Patrick K.</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #00A6A6;"></div>
        <span>Austin S.</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #7A4988;"></div>
        <span>Cathryn W.</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #06A77D;"></div>
        <span>Linda M.</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #1e3a5f;"></div>
        <span>Jason D.</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #E74C3C;"></div>
        <span>Carlos S.</span>
      </div>
      <div class="legend-item">
        <div class="legend-color" style="background: #dc3545;"></div>
        <span>‚ö†Ô∏è UNOWNED</span>
      </div>
    </div>
  </div>

  <div class="content">
    <!-- TRACKING VIEW (Current Card View) -->
    <div class="org-chart" id="trackingView">
      <div class="company">
        <h2>PARAGON PROPERTY MANAGEMENT</h2>
        <p style="margin-top: 10px; opacity: 0.9;">~150 Units | Scaling to 300-500</p>
      </div>

      <div class="departments" id="departments">
        <!-- Departments will be generated by JavaScript -->
      </div>
    </div>

    <!-- MAP VIEW (Visual Flow) -->
    <div class="flow-map-container" id="mapView">
      <svg id="flowMap"></svg>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">Total Tasks</div>
      <div class="stat-value" id="stat-total">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Assigned Tasks</div>
      <div class="stat-value" id="stat-assigned">0</div>
    </div>
    <div class="stat-card danger">
      <div class="stat-label">‚ö†Ô∏è Unowned Tasks</div>
      <div class="stat-value" id="stat-unowned">0</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Departments</div>
      <div class="stat-value" id="stat-departments">6</div>
    </div>
  </div>
</div>

<script>
  // ====================
  // DATA STRUCTURE
  // ====================
  const orgData = {
    company: "Paragon Property Management",
    departments: [
      {
        id: "accounting",
        name: "Accounting/Finance",
        color: "#06A77D",
        tasks: [
          { name: "Rent Collection Process", owner: "Linda M." },
          { name: "Owner Statement Generation", owner: "Linda M." },
          { name: "Invoice Approval Workflow", owner: "Jason D." },
          { name: "Budget Tracking & Reporting", owner: "UNOWNED" },
        ]
      },
      {
        id: "client",
        name: "Client Management",
        color: "#00A6A6",
        tasks: [
          { name: "Owner Communication", owner: "Patrick K." },
          { name: "Monthly Property Reports", owner: "Patrick K." },
          { name: "Client Onboarding Process", owner: "Jason D." },
          { name: "Client Retention Strategy", owner: "UNOWNED" },
        ]
      },
      {
        id: "compliance",
        name: "Compliance/Legal",
        color: "#7A4988",
        tasks: [
          { name: "Lease Agreement Review", owner: "Cathryn W." },
          { name: "Fair Housing Compliance", owner: "UNOWNED" },
          { name: "Eviction Process Management", owner: "Patrick K." },
          { name: "Legal Document Filing", owner: "UNOWNED" },
        ]
      },
      {
        id: "leasing",
        name: "Leasing",
        color: "#4A90E2",
        tasks: [
          { name: "Property Showings", owner: "Austin S." },
          { name: "Application Processing", owner: "Cathryn W." },
          { name: "Lease Preparation", owner: "Cathryn W." },
          { name: "Move-In Coordination", owner: "Austin S." },
          { name: "Marketing & Listings", owner: "UNOWNED" },
        ]
      },
      {
        id: "maintenance",
        name: "Maintenance",
        color: "#FF6B35",
        tasks: [
          { name: "Emergency Response Protocol", owner: "Nathan S." },
          { name: "After-Hours Coverage", owner: "UNOWNED" },
          { name: "Vendor Coordination", owner: "Nathan S." },
          { name: "Preventive Maintenance Schedule", owner: "Nathan S." },
          { name: "Unit Inspections", owner: "Nathan S." },
          { name: "Vendor Authorization & Approval", owner: "UNOWNED" },
          { name: "Work Order Tracking", owner: "Nathan S." },
        ]
      },
      {
        id: "tenant",
        name: "Tenant Management",
        color: "#F39C12",
        tasks: [
          { name: "Tenant Communication", owner: "Patrick K." },
          { name: "Lease Renewals", owner: "Cathryn W." },
          { name: "Violation Notices", owner: "Patrick K." },
          { name: "Move-Out Inspections", owner: "Nathan S." },
          { name: "Security Deposit Returns", owner: "Linda M." },
        ]
      }
    ]
  };

  // Owner color mapping
  const ownerColors = {
    "Nathan S.": { class: "owner-nathan", hex: "#FF6B35" },
    "Patrick K.": { class: "owner-patrick", hex: "#4A90E2" },
    "Austin S.": { class: "owner-austin", hex: "#00A6A6" },
    "Cathryn W.": { class: "owner-cathryn", hex: "#7A4988" },
    "Linda M.": { class: "owner-linda", hex: "#06A77D" },
    "Jason D.": { class: "owner-jason", hex: "#1e3a5f" },
    "Carlos Sanchez": { class: "owner-carlos", hex: "#E74C3C" },
    "Carlos S.": { class: "owner-carlos", hex: "#E74C3C" },
    "UNOWNED": { class: "owner-unowned", hex: "#dc3545" }
  };

  let currentView = 'tracking';

  // ====================
  // VIEW SWITCHING
  // ====================
  function switchView(view) {
    currentView = view;

    if (view === 'tracking') {
      document.getElementById('trackingView').classList.remove('hidden');
      document.getElementById('mapView').classList.remove('active');
      document.getElementById('trackingViewBtn').classList.add('active');
      document.getElementById('mapViewBtn').classList.remove('active');
      document.getElementById('expandBtn').style.display = 'block';
      document.getElementById('collapseBtn').style.display = 'block';
    } else {
      document.getElementById('trackingView').classList.add('hidden');
      document.getElementById('mapView').classList.add('active');
      document.getElementById('trackingViewBtn').classList.remove('active');
      document.getElementById('mapViewBtn').classList.add('active');
      document.getElementById('expandBtn').style.display = 'none';
      document.getElementById('collapseBtn').style.display = 'none';
      renderFlowMap();
    }
  }

  // ====================
  // TRACKING VIEW (Card View)
  // ====================
  function renderOrgChart() {
    const container = document.getElementById('departments');
    container.innerHTML = '';

    orgData.departments.forEach(dept => {
      const deptDiv = document.createElement('div');
      deptDiv.className = 'department';
      deptDiv.innerHTML = `
                    <div class="department-header dept-${dept.id}" onclick="toggleDepartment('${dept.id}')">
                        <span>${dept.name}</span>
                        <span class="expand-icon">‚ñº</span>
                    </div>
                    <div class="department-body">
                        ${dept.tasks.length > 0 ? `
                            <div class="task-list">
                                ${dept.tasks.map(task => `
                                    <div class="task-item ${task.owner === 'UNOWNED' ? 'unowned' : ''}">
                                        <div class="task-name">${task.name}</div>
                                        <div class="task-owner ${ownerColors[task.owner]?.class || 'owner-unowned'}">
                                            ${task.owner}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <p>No tasks defined yet</p>
                                <p style="font-size: 13px; margin-top: 5px;">Add tasks during task parsing session</p>
                            </div>
                        `}
                    </div>
                `;
      container.appendChild(deptDiv);
    });

    updateStats();
  }

  function toggleDepartment(deptId) {
    const deptElements = document.querySelectorAll('.department');
    deptElements.forEach(el => {
      const header = el.querySelector('.department-header');
      if (header.classList.contains(`dept-${deptId}`)) {
        el.classList.toggle('expanded');
      }
    });
  }

  function expandAll() {
    document.querySelectorAll('.department').forEach(el => {
      el.classList.add('expanded');
    });
  }

  function collapseAll() {
    document.querySelectorAll('.department').forEach(el => {
      el.classList.remove('expanded');
    });
  }

  // ====================
  // MAP VIEW (Visual Flow)
  // ====================
  function renderFlowMap() {
    const svg = document.getElementById('flowMap');
    const svgNS = "http://www.w3.org/2000/svg";

    // Clear existing content
    svg.innerHTML = '';

    // Calculate dimensions
    const width = svg.clientWidth || 1600;
    const height = Math.max(800, orgData.departments.length * 150);
    svg.setAttribute('width', width);
    svg.setAttribute('height', height);

    // Layout parameters
    const companyX = 50;
    const companyY = height / 2;
    const deptX = 300;
    const taskX = 700;
    const ownerX = width - 150;

    // Draw connections group (behind everything)
    const connectionsGroup = document.createElementNS(svgNS, 'g');
    svg.appendChild(connectionsGroup);

    // Draw company box
    drawRect(svg, companyX, companyY - 50, 200, 100, '#1e3a5f', 'PARAGON\nPROPERTY\nMANAGEMENT', '#ffffff');

    // Track owner positions for connection lines
    const ownerPositions = {};
    const uniqueOwners = [...new Set(
      orgData.departments.flatMap(d => d.tasks.map(t => t.owner))
    )];

    uniqueOwners.forEach((owner, idx) => {
      const y = 100 + (idx * 80);
      ownerPositions[owner] = { x: ownerX, y: y };
      const color = ownerColors[owner]?.hex || '#dc3545';
      drawCircle(svg, ownerX, y, 35, color, owner.split(' ')[0] + '\n' + owner.split(' ')[1] || '', '#ffffff');
    });

    // Draw departments and tasks
    orgData.departments.forEach((dept, deptIdx) => {
      const deptY = 100 + (deptIdx * 120);

      // Draw department box
      drawRect(svg, deptX, deptY - 30, 180, 60, dept.color, dept.name, '#ffffff');

      // Connect company to department
      drawLine(connectionsGroup, companyX + 200, companyY, deptX, deptY);

      // Draw tasks for this department
      dept.tasks.forEach((task, taskIdx) => {
        const taskY = deptY + (taskIdx - dept.tasks.length / 2) * 35;
        const isUnowned = task.owner === 'UNOWNED';

        // Draw task box
        const taskColor = isUnowned ? '#fff5f5' : '#f8f9fa';
        const taskBorder = isUnowned ? '#dc3545' : '#cbd5e0';
        drawTaskRect(svg, taskX, taskY - 15, 250, 30, taskColor, taskBorder, task.name, '#2c3e50');

        // Connect department to task
        drawLine(connectionsGroup, deptX + 180, deptY, taskX, taskY, isUnowned);

        // Connect task to owner
        const ownerPos = ownerPositions[task.owner];
        if (ownerPos) {
          drawLine(connectionsGroup, taskX + 250, taskY, ownerPos.x - 35, ownerPos.y, isUnowned);
        }
      });
    });
  }

  function drawRect(parent, x, y, width, height, fill, text, textColor) {
    const svgNS = "http://www.w3.org/2000/svg";
    const g = document.createElementNS(svgNS, 'g');
    g.classList.add('map-node');

    const rect = document.createElementNS(svgNS, 'rect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', width);
    rect.setAttribute('height', height);
    rect.setAttribute('fill', fill);
    rect.setAttribute('rx', 10);
    rect.setAttribute('stroke', 'rgba(0,0,0,0.1)');
    rect.setAttribute('stroke-width', 2);
    g.appendChild(rect);

    const lines = text.split('\n');
    lines.forEach((line, idx) => {
      const textEl = document.createElementNS(svgNS, 'text');
      textEl.setAttribute('x', x + width / 2);
      textEl.setAttribute('y', y + height / 2 + (idx - lines.length / 2 + 0.5) * 18);
      textEl.setAttribute('text-anchor', 'middle');
      textEl.setAttribute('dominant-baseline', 'middle');
      textEl.setAttribute('fill', textColor);
      textEl.setAttribute('font-size', '14');
      textEl.setAttribute('font-weight', '700');
      textEl.classList.add('map-node-text');
      textEl.textContent = line;
      g.appendChild(textEl);
    });

    parent.appendChild(g);
  }

  function drawTaskRect(parent, x, y, width, height, fill, border, text, textColor) {
    const svgNS = "http://www.w3.org/2000/svg";
    const g = document.createElementNS(svgNS, 'g');
    g.classList.add('map-node');

    const rect = document.createElementNS(svgNS, 'rect');
    rect.setAttribute('x', x);
    rect.setAttribute('y', y);
    rect.setAttribute('width', width);
    rect.setAttribute('height', height);
    rect.setAttribute('fill', fill);
    rect.setAttribute('rx', 5);
    rect.setAttribute('stroke', border);
    rect.setAttribute('stroke-width', 2);
    g.appendChild(rect);

    const textEl = document.createElementNS(svgNS, 'text');
    textEl.setAttribute('x', x + 10);
    textEl.setAttribute('y', y + height / 2);
    textEl.setAttribute('dominant-baseline', 'middle');
    textEl.setAttribute('fill', textColor);
    textEl.setAttribute('font-size', '12');
    textEl.setAttribute('font-weight', '600');
    textEl.classList.add('map-node-text');
    textEl.textContent = text.length > 35 ? text.substring(0, 32) + '...' : text;
    g.appendChild(textEl);

    parent.appendChild(g);
  }

  function drawCircle(parent, cx, cy, r, fill, text, textColor) {
    const svgNS = "http://www.w3.org/2000/svg";
    const g = document.createElementNS(svgNS, 'g');
    g.classList.add('map-node');

    const circle = document.createElementNS(svgNS, 'circle');
    circle.setAttribute('cx', cx);
    circle.setAttribute('cy', cy);
    circle.setAttribute('r', r);
    circle.setAttribute('fill', fill);
    circle.setAttribute('stroke', 'rgba(0,0,0,0.1)');
    circle.setAttribute('stroke-width', 2);
    g.appendChild(circle);

    const lines = text.split('\n');
    lines.forEach((line, idx) => {
      const textEl = document.createElementNS(svgNS, 'text');
      textEl.setAttribute('x', cx);
      textEl.setAttribute('y', cy + (idx - lines.length / 2 + 0.5) * 16);
      textEl.setAttribute('text-anchor', 'middle');
      textEl.setAttribute('dominant-baseline', 'middle');
      textEl.setAttribute('fill', textColor);
      textEl.setAttribute('font-size', '11');
      textEl.setAttribute('font-weight', '700');
      textEl.classList.add('map-node-text');
      textEl.textContent = line;
      g.appendChild(textEl);
    });

    parent.appendChild(g);
  }

  function drawLine(parent, x1, y1, x2, y2, isUnowned = false) {
    const svgNS = "http://www.w3.org/2000/svg";
    const line = document.createElementNS(svgNS, 'line');
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.classList.add('map-connection');
    if (isUnowned) {
      line.classList.add('unowned');
    }
    parent.appendChild(line);
  }

  // ====================
  // STATS & UTILITIES
  // ====================
  function updateStats() {
    let totalTasks = 0;
    let assignedTasks = 0;
    let unownedTasks = 0;

    orgData.departments.forEach(dept => {
      totalTasks += dept.tasks.length;
      dept.tasks.forEach(task => {
        if (task.owner === 'UNOWNED') {
          unownedTasks++;
        } else {
          assignedTasks++;
        }
      });
    });

    document.getElementById('stat-total').textContent = totalTasks;
    document.getElementById('stat-assigned').textContent = assignedTasks;
    document.getElementById('stat-unowned').textContent = unownedTasks;
  }

  function exportToPNG() {
    alert('üí° TIP: Use your browser\'s screenshot tool or press Ctrl+Shift+S (Windows) / Cmd+Shift+4 (Mac) to capture the map.\n\nFor a cleaner export, try "Print" and save as PDF.');
  }

  function printMap() {
    if (currentView === 'tracking') {
      expandAll();
    }
    setTimeout(() => {
      window.print();
    }, 300);
  }

  // ====================
  // INITIALIZATION
  // ====================
  document.addEventListener('DOMContentLoaded', () => {
    renderOrgChart();
    expandAll();
  });

  // Add keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey || e.metaKey) {
      if (e.key === 'e') {
        e.preventDefault();
        expandAll();
      } else if (e.key === 'c') {
        e.preventDefault();
        collapseAll();
      } else if (e.key === 'm') {
        e.preventDefault();
        switchView(currentView === 'tracking' ? 'map' : 'tracking');
      }
    }
  });
</script>
</body>
</html>
